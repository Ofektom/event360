// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User/Account model - for event creators and family members
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  phone         String?
  passwordHash  String?   // For password-based auth
  image         String?   // Profile picture
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // Relations
  events        Event[]
  invitees      Invitee[]      // Events they're invited to (as guests)
  familyMembers FamilyMember[]
  interactions  Interaction[]
  mediaAssets   MediaAsset[]
  vendor        Vendor?        // One-to-one: User can be a vendor
  vendorRatings VendorRating[] // Ratings given by this user to vendors

  @@index([email])
}

enum UserRole {
  USER
  VENDOR
  ADMIN
}

// Family/Account grouping - allows multiple family members to manage events
model Family {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique // For custom URLs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members   FamilyMember[]
  events    Event[]

  @@index([slug])
}

// Family membership - links users to families with roles
model FamilyMember {
  id        String         @id @default(cuid())
  userId    String
  familyId  String
  role      FamilyRole     @default(MEMBER)
  createdAt DateTime       @default(now())

  // Relations
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  family    Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([userId, familyId])
  @@index([familyId])
}

enum FamilyRole {
  OWNER
  ADMIN
  MEMBER
}

// Event Theme/Template
model Theme {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String   // e.g., "wedding", "birthday", "corporate"
  config      Json     // Theme configuration (colors, fonts, layouts)
  preview     String?  // Preview image URL
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  events      Event[]

  @@index([category])
}

// Main Event - parent event (e.g., "Wedding Celebration")
model Event {
  id          String      @id @default(cuid())
  title       String
  description String?
  slug        String      @unique // For public URLs
  type        EventType   @default(CELEBRATION)
  status      EventStatus @default(DRAFT)
  
  // Theme and styling
  themeId     String?
  customTheme Json?       // Custom theme overrides
  
  // Owner and family
  ownerId     String
  familyId    String?
  
  // Event metadata
  startDate   DateTime?
  endDate     DateTime?
  location    String?
  timezone    String      @default("UTC")
  
  // Settings
  isPublic    Boolean     @default(false)
  visibility  EventVisibility @default(PUBLIC) // Who can view this event (default: everyone on the app)
  allowGuestUploads Boolean @default(true)
  allowComments    Boolean @default(true)
  allowReactions   Boolean @default(true)
  
  // QR Code and sharing
  qrCode      String?     @unique
  shareLink   String?     @unique
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  owner       User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  family      Family?     @relation(fields: [familyId], references: [id], onDelete: SetNull)
  theme       Theme?      @relation(fields: [themeId], references: [id], onDelete: SetNull)
  ceremonies  Ceremony[]
  invitees    Invitee[]
  mediaAssets MediaAsset[]
  invites     Invite[]
  interactions Interaction[]
  invitationDesigns InvitationDesign[]
  eventVendors EventVendor[]
  vendorRatings VendorRating[]

  @@index([slug])
  @@index([ownerId])
  @@index([familyId])
  @@index([status])
}

enum EventType {
  CELEBRATION
  WEDDING
  BIRTHDAY
  CORPORATE
  CONFERENCE
  OTHER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  LIVE
  COMPLETED
  CANCELLED
}

enum EventVisibility {
  PUBLIC          // Anyone on the application
  CONNECTED       // Anyone connected to the user on the app
  INVITED_ONLY    // Only invited guests on the app
}

// Ceremony - multiple ceremonies per event (e.g., Traditional, White Wedding)
model Ceremony {
  id          String   @id @default(cuid())
  eventId     String
  name        String   // e.g., "Traditional Marriage", "White Wedding"
  description String?
  order       Int      // Order of ceremonies
  date        DateTime
  startTime   DateTime?
  endTime     DateTime?
  location    String?
  venue       String?
  dressCode   String?
  notes       String?
  
  // Streaming
  streamUrl   String?
  streamKey   String?
  isStreaming Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  scheduleItems ScheduleItem[]
  mediaAssets MediaAsset[]
  interactions Interaction[]

  @@index([eventId])
  @@index([eventId, order])
}

// Schedule Item - order of events within a ceremony
model ScheduleItem {
  id          String   @id @default(cuid())
  ceremonyId  String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime?
  order       Int
  type        String?  // e.g., "ceremony", "reception", "dinner"
  location    String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  ceremony    Ceremony @relation(fields: [ceremonyId], references: [id], onDelete: Cascade)

  @@index([ceremonyId])
  @@index([ceremonyId, order])
}

// Invitee/Guest
model Invitee {
  id          String      @id @default(cuid())
  eventId     String
  userId      String?     // Link to User when they register
  name        String
  email       String?
  phone       String?
  whatsapp    String?     // WhatsApp number (can be same as phone or different)
  messenger   String?     // Facebook Messenger username/ID
  instagram   String?     // Instagram handle
  role        String?     // e.g., "bride", "groom", "guest", "vendor"
  group       String?     // e.g., "bride's family", "groom's family"
  
  // RSVP tracking
  rsvpStatus  RSVPStatus  @default(PENDING)
  rsvpDate    DateTime?
  rsvpNotes   String?
  
  // Attendance tracking
  attendedCeremonies String[] // Array of ceremony IDs
  
  // Contact preferences
  preferredChannel String? // "email", "whatsapp", "sms", "messenger", "in-app"
  
  // Registration tracking
  registeredAt DateTime?  // When they registered/linked account
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  event       Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  invites     Invite[]

  @@index([eventId])
  @@index([userId])
  @@index([email])
  @@index([phone])
  @@index([whatsapp])
  @@unique([eventId, email])  // One invitee per email per event
  @@unique([eventId, phone])  // One invitee per phone per event
}

enum RSVPStatus {
  PENDING
  ACCEPTED
  DECLINED
  MAYBE
}

// Invitation tracking
model Invite {
  id          String        @id @default(cuid())
  eventId     String
  inviteeId   String?
  email       String?
  phone       String?
  channel     InviteChannel
  status      InviteStatus  @default(PENDING)
  sentAt      DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  error       String?
  token       String        @unique // For tracking
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  event       Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  invitee     Invitee?      @relation(fields: [inviteeId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([token])
  @@index([email])
  @@index([phone])
}

enum InviteChannel {
  EMAIL
  WHATSAPP
  SMS
  FACEBOOK_MESSENGER
  INSTAGRAM_DM
  LINK
  QR_CODE
}

enum InviteStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

// Media Assets - photos and videos
model MediaAsset {
  id          String        @id @default(cuid())
  eventId     String
  ceremonyId  String?
  uploadedById String?
  
  // Media info
  type        MediaType
  url         String        // Storage URL
  thumbnailUrl String?
  filename    String
  mimeType    String
  size        Int           // Size in bytes
  width       Int?
  height      Int?
  duration    Int?          // For videos, in seconds
  
  // Metadata
  caption     String?
  tags        String[]      // Array of tags
  source      MediaSource   @default(UPLOAD)
  sourceUrl   String?       // Original source if from social media
  
  // Social media integration
  socialMediaId String?     // ID from social platform
  socialPlatform String?    // "whatsapp", "instagram", "facebook"
  
  // Engagement
  viewCount   Int           @default(0)
  likeCount   Int           @default(0)
  
  // Moderation
  isApproved  Boolean       @default(true)
  isFeatured  Boolean       @default(false)
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  event       Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ceremony    Ceremony?     @relation(fields: [ceremonyId], references: [id], onDelete: SetNull)
  uploadedBy  User?         @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  interactions Interaction[]

  @@index([eventId])
  @@index([ceremonyId])
  @@index([uploadedById])
  @@index([source])
  @@index([isApproved])
  @@index([isFeatured])
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
}

enum MediaSource {
  UPLOAD
  WHATSAPP
  INSTAGRAM
  FACEBOOK
  EMAIL
  LINK
}

// Interactions - comments, reactions, guestbook entries
model Interaction {
  id          String          @id @default(cuid())
  eventId     String
  ceremonyId  String?
  mediaAssetId String?
  userId      String?
  parentId    String?         // For replies to comments
  
  // Interaction details
  type        InteractionType
  content     String?         // For comments/guestbook
  reaction    ReactionType?   // For reactions
  
  // Guest info (for non-registered users)
  guestName   String?
  guestEmail  String?
  
  // Moderation
  isApproved  Boolean         @default(true)
  isPinned    Boolean         @default(false)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  event       Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ceremony    Ceremony?       @relation(fields: [ceremonyId], references: [id], onDelete: Cascade)
  mediaAsset  MediaAsset?     @relation(fields: [mediaAssetId], references: [id], onDelete: Cascade)
  user        User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  parent      Interaction?    @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Interaction[]   @relation("CommentReplies")

  @@index([eventId])
  @@index([ceremonyId])
  @@index([mediaAssetId])
  @@index([type])
  @@index([isApproved])
  @@index([parentId])
}

enum InteractionType {
  COMMENT
  REACTION
  GUESTBOOK
  BLESSING
  WISH
}

enum ReactionType {
  LIKE
  LOVE
  CELEBRATE
  CLAP
  THUMBS_UP
  HEART
  FIRE
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Invitation Templates - Pre-designed templates for invitations
model InvitationTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String   // e.g., "wedding", "birthday", "corporate"
  preview     String?  // Preview image URL
  config      Json     // Template configuration (layout, default colors, text fields, graphics)
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  designs     InvitationDesign[]

  @@index([category])
  @@index([isActive])
}

// Shapes and Symbols - Reusable design elements for invitations
model DesignShape {
  id          String   @id @default(cuid())
  name        String
  category    String   // e.g., "geometric", "decorative", "symbols", "icons"
  type        String   // "shape" or "symbol"
  svgPath     String   // SVG path data or full SVG
  defaultColor String  @default("#9333ea")
  isDefault   Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([type])
  @@index([isActive])
}

// Invitation Designs - User's customized invitations for events
model InvitationDesign {
  id          String   @id @default(cuid())
  eventId     String
  templateId  String?  // If using a template, null if custom upload
  name        String?  // User's name for this design
  
  // Design data
  designData  Json     // Customizations (text, colors, graphics, layout)
  imageUrl    String?  // Final rendered image URL (if generated)
  customImage String?  // If user uploaded custom image
  
  // Status
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false) // Default design for this event
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  template    InvitationTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([eventId])
  @@index([templateId])
}

// Vendor - Service providers for events
model Vendor {
  id              String   @id @default(cuid())
  ownerName       String?  // Owner/person name (e.g., "John Doe")
  businessName    String?  // Business/brand name (e.g., "Elegant Events Co.")
  category        VendorCategory
  description     String?
  
  // Contact Information
  email           String
  phone           String   // WhatsApp number
  whatsapp        String?  // Explicit WhatsApp field
  website         String?
  socialMedia     Json?    // { instagram, facebook, twitter }
  
  // Location (for proximity search)
  address         String?
  city            String?
  state           String?
  country         String?
  latitude        Float?   // For geolocation
  longitude       Float?   // For geolocation
  
  // Profile
  logo            String?  // Profile image
  coverImage      String?
  portfolio       Json?    // Array of image URLs
  
  // Status
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?  // When vendor was verified
  verifiedBy      String?    // Admin who verified (optional)
  isActive        Boolean  @default(true)
  invitationSent  Boolean  @default(false)
  invitationToken String?  @unique // For invitation link
  userId          String?  @unique // Linked user account (after signup)
  
  // Ratings & SEO
  averageRating   Float    @default(0)
  totalRatings    Int      @default(0)
  seoScore        Float    @default(0) // Calculated from ratings, reviews, activity
  
  // Reminder preferences
  reminderPreferences Json?  // { whatsapp: true, email: true, daysBefore: [7, 1] }
  
  // Availability
  availability    Json?    // Calendar/availability data
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventVendors    EventVendor[]
  ratings         VendorRating[]
  
  @@index([category])
  @@index([city, state])
  @@index([averageRating])
  @@index([seoScore])
  @@index([email])
  @@index([phone])
  @@index([invitationToken])
  @@index([isVerified])
  @@index([isActive])
}

enum VendorCategory {
  MAKEUP_ARTIST
  RENTALS
  BRIDALS
  FASHION_DESIGNER
  HAIR_STYLIST
  BARBER
  COOK
  DECORATOR
  CAKE_PASTRY_MAKER
  BAND
  GROOMING_ARTIST
  MC_COMPERE
  PHOTOGRAPHER
  VIDEOGRAPHER
  DJ
  CATERER
  FLORIST
}

model EventVendor {
  id          String   @id @default(cuid())
  eventId     String
  vendorId    String
  role        String?  // e.g., "Primary", "Secondary", "Backup"
  notes       String?  // Event-specific notes
  status      EventVendorStatus @default(PENDING) // PENDING, ACCEPTED, DECLINED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, vendorId])
  @@index([eventId])
  @@index([vendorId])
  @@index([status])
}

enum EventVendorStatus {
  PENDING
  ACCEPTED
  DECLINED
  COMPLETED
  CANCELLED
}

model VendorRating {
  id          String   @id @default(cuid())
  vendorId    String
  eventId     String?  // Optional - can rate without event context
  userId      String   // User who rated
  rating      Int      // 1-5 stars
  review      String?  // Optional text review
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([vendorId, userId, eventId]) // One rating per user per vendor per event
  @@index([vendorId])
  @@index([eventId])
  @@index([userId])
}
